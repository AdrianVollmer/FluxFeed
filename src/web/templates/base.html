<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}FluxFeed - RSS Reader{% endblock %}</title>
    {# PWA Meta Tags #}
    <meta name="theme-color" content="#3b82f6">
    <meta name="description" content="A modern RSS feed reader">
    <link rel="manifest" href="/static/manifest.webmanifest">
    {# Apple-specific meta tags for iOS #}
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="FluxFeed">
    <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">
    {# Favicon #}
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="stylesheet" href="/static/css/tailwind.css">
    <script src="/static/js/htmx.min.js"></script>
    <script>
        // CSRF protection: Configure HTMX to send CSRF token with all requests
        (function() {
            function getCsrfToken() {
                const match = document.cookie.match(/csrf_token=([^;]+)/);
                return match ? match[1] : '';
            }
            // Configure HTMX to send CSRF token in header for all requests
            document.addEventListener('htmx:configRequest', function(event) {
                event.detail.headers['X-CSRF-Token'] = getCsrfToken();
            });
        })();
    </script>
    <script src="{{ "modal-dialog.js"|js_path }}" defer></script>
    {% block scripts %}{% endblock %}
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
    {% include "components/header.html" %}

    <main class="container mx-auto px-4 py-8 max-w-7xl">
        {% block content %}{% endblock %}
    </main>

    <footer class="mt-16 py-6 border-t border-gray-200 dark:border-gray-700">
        <div class="container mx-auto px-4 text-center text-sm text-gray-600 dark:text-gray-400">
            <p class="mb-2">FluxFeed v{{ ""|app_version }} - A modern RSS feed reader</p>
            <a href="https://github.com/AdrianVollmer/FluxFeed" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">
                {% include "icons/github.html" %}
                <span>View on GitHub</span>
            </a>
        </div>
    </footer>

    {# Service Worker Registration #}
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/static/service-worker.js', {
                    scope: '/'
                }).then(function(registration) {
                    console.log('ServiceWorker registered:', registration.scope);
                }).catch(function(error) {
                    console.log('ServiceWorker registration failed:', error);
                });
            });
        }
    </script>

    {# Mobile swipe gesture for nav #}
    <script>
        (function() {
            let touchStartX = 0;
            let touchStartY = 0;
            const edgeThreshold = 30; // px from left edge to trigger
            const swipeThreshold = 50; // min px to count as swipe

            document.addEventListener('touchstart', function(e) {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            }, { passive: true });

            document.addEventListener('touchend', function(e) {
                const touchEndX = e.changedTouches[0].clientX;
                const touchEndY = e.changedTouches[0].clientY;
                const deltaX = touchEndX - touchStartX;
                const deltaY = Math.abs(touchEndY - touchStartY);
                const toggle = document.getElementById('mobile-nav-toggle');

                if (!toggle || deltaY > Math.abs(deltaX)) return; // ignore vertical swipes

                // Swipe right from left edge -> open nav
                if (touchStartX < edgeThreshold && deltaX > swipeThreshold && !toggle.checked) {
                    toggle.checked = true;
                }
                // Swipe left while nav is open -> close nav
                else if (deltaX < -swipeThreshold && toggle.checked) {
                    toggle.checked = false;
                }
            }, { passive: true });
        })();
    </script>
</body>
</html>
