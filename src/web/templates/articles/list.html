{% extends "base.html" %}

{% block title %}Articles - FluxFeed{% endblock %}

{% block scripts %}
<script src="{{ "articles.js"|js_path }}" defer></script>
<script src="{{ "feed-filter.js"|js_path }}" defer></script>
<script src="{{ "tag-filter.js"|js_path }}" defer></script>
{% include "articles/_mobile_nav_filters.html" %}
{% endblock %}

{% block content %}
{% if view_mode == "fullscreen" %}
<script>
// Apply fullscreen classes to main element immediately to avoid flicker
document.currentScript.parentElement.classList.remove('container', 'max-w-7xl');
document.currentScript.parentElement.classList.add('fullscreen-main');
</script>
{% endif %}
<div class="{% if view_mode == "fullscreen" %}fullscreen-container{% else %}max-w-6xl mx-auto{% endif %}" id="articles-container">
    {# Normal Layout (Cards/Compact) #}
    <div id="normal-layout" class="{% if view_mode == "fullscreen" %}hidden {% endif %}flex gap-8">
        {# Sidebar (desktop only) #}
        {% include "articles/_sidebar.html" %}

        {# Main Content #}
        <div class="flex-1 min-w-0">
            {# Header with filter indicator (mobile) #}
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold">Articles</h1>

                {# Mobile: Current filter indicator #}
                <div class="lg:hidden text-sm text-gray-600 dark:text-gray-400">
                    {% if active_filter == "unread" %}
                        Unread ({{ article_counts.unread }})
                    {% else if active_filter == "starred" %}
                        Starred ({{ article_counts.starred }})
                    {% else if active_filter == "read" %}
                        Read ({{ article_counts.read }})
                    {% else %}
                        All ({{ article_counts.total }})
                    {% endif %}
                </div>
            </div>

            {# Modal container for feed filter #}
            <div id="feed-filter-modal"></div>

            {# Modal container for tag filter #}
            <div id="tag-filter-modal"></div>

            {# Article list - Cards View #}
            <div id="articles-cards" class="{% if view_mode == "compact" %}hidden {% endif %}space-y-4">
                {% if articles.len() == 0 %}
                <div class="card empty-state">
                    <div class="empty-state-icon">
                        {% include "icons/newspaper.html" %}
                    </div>
                    <p class="empty-state-title">
                        {% if active_filter == "unread" %}
                            No unread articles
                        {% else if active_filter == "starred" %}
                            No starred articles
                        {% else if active_filter == "read" %}
                            No read articles
                        {% else %}
                            No articles yet
                        {% endif %}
                    </p>
                    <p class="empty-state-description">
                        {% if feeds.len() == 0 %}
                            <a href="/feeds" class="text-blue-600 hover:underline">Add some feeds</a> to get started!
                        {% else if active_filter == "unread" %}
                            You're all caught up! <a href="/articles?show=all" class="text-blue-600 hover:underline">View all articles</a>
                        {% else %}
                            Articles will appear here automatically. The next fetch is scheduled soon.
                        {% endif %}
                    </p>
                </div>
                {% else %}
                {% include "articles/_article_rows.html" %}
                {% endif %}
            </div>

            {# Article list - Compact View #}
            <div id="articles-compact" class="{% if view_mode != "compact" %}hidden{% endif %}">
                {% if articles.len() == 0 %}
                <div class="card empty-state">
                    <div class="empty-state-icon">
                        {% include "icons/newspaper.html" %}
                    </div>
                    <p class="empty-state-title">
                        {% if active_filter == "unread" %}
                            No unread articles
                        {% else if active_filter == "starred" %}
                            No starred articles
                        {% else if active_filter == "read" %}
                            No read articles
                        {% else %}
                            No articles yet
                        {% endif %}
                    </p>
                    <p class="empty-state-description">
                        {% if feeds.len() == 0 %}
                            <a href="/feeds" class="text-blue-600 hover:underline">Add some feeds</a> to get started!
                        {% else if active_filter == "unread" %}
                            You're all caught up! <a href="/articles?show=all" class="text-blue-600 hover:underline">View all articles</a>
                        {% else %}
                            Articles will appear here automatically. The next fetch is scheduled soon.
                        {% endif %}
                    </p>
                </div>
                {% else %}
                {# Desktop header (hidden on mobile) #}
                <div class="hidden md:grid md:grid-cols-[auto_1fr_160px_120px_115px_90px] md:gap-2 bg-gray-50 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
                    <div class="w-8 px-3 py-3"></div>
                    <div class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Title</div>
                    <div class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Feed</div>
                    <div class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Author</div>
                    <div class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Date</div>
                    <div class="w-16 px-3 py-3"></div>
                </div>
                {# Compact article rows #}
                <div class="bg-white dark:bg-gray-800">
                    {% include "articles/_article_compact_rows.html" %}
                </div>
                {% endif %}
            </div>

            {# Article list footer (Show more + Scroll to top + Mark all as read) #}
            {% if articles.len() > 0 %}
            <div id="article-list-footer" class="mt-8 flex flex-col sm:flex-row gap-4 justify-center items-center">
                {% if has_more %}
                <button
                    id="load-more-btn"
                    hx-get="/articles?offset={{ offset + limit }}{% if !filter_feed_ids.is_empty() %}&feed_ids={{ filter_feed_ids|join(",") }}{% endif %}{% if !filter_group_ids.is_empty() %}&group_ids={{ filter_group_ids|join(",") }}{% endif %}{% if !filter_tag_ids.is_empty() %}&tag_ids={{ filter_tag_ids|join(",") }}{% endif %}{% if filter_read.is_some() %}&is_read={{ filter_read.unwrap() }}{% endif %}{% if filter_starred.is_some() %}&is_starred={{ filter_starred.unwrap() }}{% endif %}"
                    hx-target="#articles-cards"
                    hx-swap="beforeend"
                    class="btn btn-primary w-full sm:w-44 flex items-center justify-center gap-2">
                    Show More Articles
                </button>
                {% endif %}

                <button
                    onclick="window.scrollTo({ top: 0, behavior: 'smooth' })"
                    class="btn btn-secondary w-full sm:w-44 flex items-center justify-center gap-2">
                    {% include "icons/arrow-up.html" %}
                    Scroll to Top
                </button>

                {% if active_filter != "read" %}
                <button
                    hx-post="/articles/mark-all-read{% if !filter_feed_ids.is_empty() %}?feed_ids={{ filter_feed_ids|join(",") }}{% endif %}"
                    hx-confirm="Are you sure you want to mark all {% if !filter_feed_ids.is_empty() || !filter_group_ids.is_empty() %}filtered {% endif %}articles as read?"
                    class="btn btn-secondary w-full sm:w-44 flex items-center justify-center gap-2">
                    {% include "icons/check-double.html" %}
                    Mark All as Read
                </button>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    {# Fullscreen Layout (Three horizontal columns: Groups | Articles | Content) #}
    <div id="fullscreen-layout" class="{% if view_mode != "fullscreen" %}hidden {% endif %}h-full">
        <div class="flex h-full border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden bg-white dark:bg-gray-800">
            {# Groups Column #}
            <div class="w-[15%] min-w-[180px] flex flex-col border-r border-gray-200 dark:border-gray-700">
                <div class="p-3 border-b border-gray-200 dark:border-gray-700">
                    {# View toggle header #}
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">View</h3>
                    </div>
                    <div class="flex gap-1 p-0.5 bg-gray-100 dark:bg-gray-700 rounded">
                        <button id="view-cards-fullscreen" onclick="setView('cards')" title="Cards view"
                            class="flex-1 px-2 py-1 rounded text-xs font-medium transition flex items-center justify-center">
                            {% include "icons/grid.html" %}
                        </button>
                        <button id="view-compact-fullscreen" onclick="setView('compact')" title="List view"
                            class="flex-1 px-2 py-1 rounded text-xs font-medium transition flex items-center justify-center">
                            {% include "icons/list.html" %}
                        </button>
                        <button id="view-fullscreen-fullscreen" onclick="setView('fullscreen')" title="Full view"
                            class="flex-1 px-2 py-1 rounded text-xs font-medium transition flex items-center justify-center bg-blue-600 text-white">
                            {% include "icons/columns.html" %}
                        </button>
                    </div>
                </div>

                <div class="p-3 border-b border-gray-200 dark:border-gray-700">
                    {# Show filter #}
                    <h3 class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2">Show</h3>
                    <div class="flex flex-col gap-1">
                        <a href="/articles?is_read=false"
                           class="px-2 py-1 text-xs rounded transition
                                  {% if active_filter == "unread" %}bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300{% else %}hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-400{% endif %}">
                            Unread ({{ article_counts.unread }})
                        </a>
                        <a href="/articles?show=all"
                           class="px-2 py-1 text-xs rounded transition
                                  {% if active_filter == "all" %}bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300{% else %}hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-400{% endif %}">
                            All ({{ article_counts.total }})
                        </a>
                        <a href="/articles?is_starred=true"
                           class="px-2 py-1 text-xs rounded transition
                                  {% if active_filter == "starred" %}bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300{% else %}hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-400{% endif %}">
                            Starred ({{ article_counts.starred }})
                        </a>
                    </div>
                </div>

                {# Group tree #}
                <div class="flex-1 overflow-y-auto p-3">
                    <h3 class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2">Feeds</h3>
                    <div class="space-y-0.5">
                        {% for group_node in group_tree %}
                        {% include "articles/_fullscreen_group_item.html" %}
                        {% endfor %}

                        {# Ungrouped feeds #}
                        {% if !ungrouped_feeds.is_empty() %}
                        <div class="mt-2 pt-2 border-t border-gray-200 dark:border-gray-700">
                            <div class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-1 px-2">Ungrouped</div>
                            {% for feed in ungrouped_feeds %}
                            <a href="/articles?feed_ids={{ feed.id }}"
                               class="flex items-center gap-2 py-1 px-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-sm text-gray-700 dark:text-gray-300 truncate">
                                {% include "components/_feed_color_dot.html" %}
                                <span class="truncate">{{ feed.title }}</span>
                            </a>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            {# Articles Column #}
            <div class="w-[35%] flex flex-col border-r border-gray-200 dark:border-gray-700">
                <div class="p-3 border-b border-gray-200 dark:border-gray-700">
                    <h3 class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Articles</h3>
                </div>
                <div class="flex-1 overflow-y-auto">
                    {% if articles.len() == 0 %}
                    <div class="flex items-center justify-center h-full text-gray-500 dark:text-gray-400 text-sm">
                        <div class="text-center p-4">
                            {% include "icons/newspaper.html" %}
                            <p class="mt-2">No articles to display</p>
                        </div>
                    </div>
                    {% else %}
                    <div id="fullscreen-article-list">
                        {% include "articles/_article_fullscreen_rows.html" %}
                    </div>
                    <div
                        id="fullscreen-load-more"
                        {% if has_more %}data-load-url="/articles?offset={{ offset + limit }}&view=fullscreen{% if !filter_feed_ids.is_empty() %}&feed_ids={{ filter_feed_ids|join(",") }}{% endif %}{% if !filter_group_ids.is_empty() %}&group_ids={{ filter_group_ids|join(",") }}{% endif %}{% if !filter_tag_ids.is_empty() %}&tag_ids={{ filter_tag_ids|join(",") }}{% endif %}{% if filter_read.is_some() %}&is_read={{ filter_read.unwrap() }}{% endif %}{% if filter_starred.is_some() %}&is_starred={{ filter_starred.unwrap() }}{% endif %}"{% endif %}
                        class="{% if has_more %}flex{% else %}hidden{% endif %} items-center justify-center py-4 text-gray-500 dark:text-gray-400">
                        <svg class="animate-spin h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span class="text-sm">Loading more...</span>
                    </div>
                    {% endif %}
                </div>
            </div>

            {# Content Column (50% width) #}
            <div class="w-1/2 overflow-hidden bg-gray-50 dark:bg-gray-900">
                <div id="fullscreen-content" class="h-full overflow-y-auto">
                    <div class="flex items-center justify-center h-full text-gray-500 dark:text-gray-400">
                        <div class="text-center p-8">
                            {% include "icons/newspaper.html" %}
                            <p class="mt-4 text-lg">Select an article to read</p>
                            <p class="mt-2 text-sm">Click on any article in the list to view its content here</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}
