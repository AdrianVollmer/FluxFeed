<!-- Modal overlay -->
<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="if (event.target === this) closeFeedFilterModal()">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-lg w-full mx-4 max-h-[80vh] flex flex-col" onclick="event.stopPropagation()">
        <!-- Header -->
        <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white">Filter by Feeds</h2>
            <button onclick="closeFeedFilterModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- Content -->
        <div class="flex-1 overflow-y-auto p-4">
            <form id="feed-filter-form">
                <!-- Quick actions -->
                <div class="flex gap-2 mb-4">
                    <button type="button" onclick="selectAllFeeds()" class="btn btn-secondary text-sm py-1 px-3">Select All</button>
                    <button type="button" onclick="selectNoneFeeds()" class="btn btn-secondary text-sm py-1 px-3">Clear</button>
                </div>

                <!-- Hierarchical tree -->
                <div class="space-y-1">
                    {% for group_node in group_tree %}
                    {% include "articles/_group_tree_item.html" %}
                    {% endfor %}

                    <!-- Ungrouped feeds section -->
                    {% if !ungrouped_feeds.is_empty() %}
                    <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                        <div class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">Ungrouped</div>
                        {% for feed in ungrouped_feeds %}
                        <label class="flex items-center gap-2 py-1 px-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded cursor-pointer">
                            <input type="checkbox" name="feed_ids" value="{{ feed.id }}"
                                   {% if feed.id|in_list(selected_feed_ids) %}checked{% endif %}
                                   class="feed-checkbox rounded border-gray-300 dark:border-gray-600 text-blue-600 focus:ring-blue-500">
                            <span class="w-3 h-3 rounded-full flex-shrink-0" style="background-color: {{ feed.color }}"></span>
                            <span class="text-sm text-gray-700 dark:text-gray-300 truncate">{{ feed.title }}</span>
                        </label>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <!-- Empty state -->
                    {% if group_tree.is_empty() && ungrouped_feeds.is_empty() %}
                    <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                        <svg class="w-12 h-12 mx-auto mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 5c7.18 0 13 5.82 13 13M6 11a7 7 0 017 7m-6 0a1 1 0 11-2 0 1 1 0 012 0z"></path>
                        </svg>
                        <p>No feeds available</p>
                        <a href="/feeds" class="text-blue-600 hover:underline text-sm">Add some feeds</a>
                    </div>
                    {% endif %}
                </div>
            </form>
        </div>

        <!-- Footer -->
        <div class="flex justify-end gap-3 p-4 border-t border-gray-200 dark:border-gray-700">
            <button type="button" onclick="closeFeedFilterModal()" class="btn btn-secondary">
                Cancel
            </button>
            <button type="button" onclick="applyFeedFilter()" class="btn btn-primary">
                Apply Filter
            </button>
        </div>
    </div>
</div>

<script>
function closeFeedFilterModal() {
    document.getElementById('feed-filter-modal').innerHTML = '';
}

function selectAllFeeds() {
    document.querySelectorAll('.feed-checkbox, .group-checkbox').forEach(cb => cb.checked = true);
}

function selectNoneFeeds() {
    document.querySelectorAll('.feed-checkbox, .group-checkbox').forEach(cb => cb.checked = false);
}

function applyFeedFilter() {
    const feedIds = Array.from(document.querySelectorAll('.feed-checkbox:checked'))
        .map(cb => cb.value);
    const groupIds = Array.from(document.querySelectorAll('.group-checkbox:checked'))
        .map(cb => cb.value);

    const params = new URLSearchParams(window.location.search);

    // Clear existing filter params
    params.delete('feed_ids');
    params.delete('group_ids');
    params.delete('offset'); // Reset pagination when filter changes

    if (feedIds.length > 0) {
        params.set('feed_ids', feedIds.join(','));
    }
    if (groupIds.length > 0) {
        params.set('group_ids', groupIds.join(','));
    }

    const queryString = params.toString();
    window.location.href = '/articles' + (queryString ? '?' + queryString : '');
}

// Toggle group checkbox cascades to all child checkboxes
document.querySelectorAll('.group-checkbox').forEach(groupCb => {
    groupCb.addEventListener('change', function() {
        const container = this.closest('.group-container');
        if (container) {
            container.querySelectorAll('.feed-checkbox, .group-checkbox').forEach(cb => {
                if (cb !== this) {
                    cb.checked = this.checked;
                }
            });
        }
    });
});

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeFeedFilterModal();
    }
});
</script>
